{% extends "base.html" %}
{% block content %}

<h1 class="page-title">管理者画面</h1>
<p class="page-sub">入庫待ちの処理、現在の入庫状況、履歴をまとめて確認できます。</p>

<div class="grid">

  <!-- Stats -->
  <div class="col-12 card">
    <div class="grid">
      <div class="col-4 stat">
        <div>
          <div class="label">入庫待ち件数</div>
          <div class="value">{{ queue_size }}</div>
        </div>
        <span class="badge badge-wait">WAITING</span>
      </div>

      <div class="col-4 stat">
        <div>
          <div class="label">入庫中（ACTIVE）</div>
          <div class="value">{{ active|length }}</div>
        </div>
        <span class="badge badge-active">ACTIVE</span>
      </div>

      <div class="col-4 stat">
        <div>
          <div class="label">履歴（DONE / CANCELED）</div>
          <div class="value">{{ history|length }}</div>
        </div>
        <span class="badge">HISTORY</span>
      </div>
    </div>

    <div class="btn-row">
      <form method="post" action="{{ url_for('admin_process_checkin') }}">
        <button class="btn-primary">入庫許可（次の1台）</button>
      </form>

      <form method="post" action="{{ url_for('admin_undo') }}">
        <button class="btn-danger">Undo（直前を取り消す）</button>
      </form>
    </div>
  </div>

  <!-- WAITING -->
  <div class="col-6 card">
    <h2 style="margin:0 0 8px;">WAITING（入庫待ち）</h2>
    {% if waiting %}
      <table>
        <tr>
          <th>ID</th>
          <th>ユーザー</th>
          <th>車牌</th>
          <th>区画</th>
        </tr>
        {% for r in waiting %}
          <tr>
            <td><span class="badge badge-wait">{{ r.reservation_id }}</span></td>
            <td>{{ r.username|default('-', true) }}</td>
            <td>{{ r.license_plate }}</td>
            <td>{{ r.spot_id }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <div class="empty">入庫待ちはありません</div>
    {% endif %}
  </div>

  <!-- ACTIVE -->
  <div class="col-6 card">
    <h2 style="margin:0 0 8px;">ACTIVE（入庫中）</h2>
    {% if active %}
      <table>
        <tr>
          <th>ID</th>
          <th>ユーザー</th>
          <th>車牌</th>
          <th>ゲート</th>
          <th>区画</th>
        </tr>
        {% for r in active %}
          <tr>
            <td><span class="badge badge-active">{{ r.reservation_id }}</span></td>
            <td>{{ r.username|default('-', true) }}</td>
            <td>{{ r.license_plate }}</td>
            <td>{{ r.gate }}</td>
            <td>{{ r.spot_id }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <div class="empty">ACTIVEの予約はありません</div>
    {% endif %}
  </div>

  <!-- HISTORY -->
  <div class="col-12 card">
    <h2 style="margin:0 0 8px;">履歴</h2>
    {% if history %}
      <table>
        <tr>
          <th>ID</th>
          <th>ユーザー</th>
          <th>状態</th>
          <th>車牌</th>
          <th>区画</th>
        </tr>
        {% for r in history %}
          <tr>
            <td><span class="badge">{{ r.reservation_id }}</span></td>
            <td>{{ r.username|default('-', true) }}</td>
            <td>
              {% if r.status.value == "DONE" %}
                <span class="badge badge-done">DONE</span>
              {% elif r.status.value == "CANCELED" %}
                <span class="badge badge-cancel">CANCELED</span>
              {% else %}
                <span class="badge">{{ r.status.value }}</span>
              {% endif %}
            </td>
            <td>{{ r.license_plate }}</td>
            <td>{{ r.spot_id }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <div class="empty">履歴はありません</div>
    {% endif %}
  </div>

</div>

{% endblock %}
